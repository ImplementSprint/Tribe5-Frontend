name: Frontend Web CI/CD Pipeline

on:
  workflow_call:
    inputs:
      system-dir:
        required: true
        type: string
        description: 'System Name (Used for Artifacts/Sonar, NOT path)'
      sonar-project-key:
        required: true
        type: string
        description: 'SonarCloud project key'
      sonar-organization:
        required: false
        type: string
        default: 'implementsprint'
        description: 'SonarCloud organization'
      coverage-threshold:
        required: false
        type: number
        default: 80
        description: 'Minimum code coverage percentage required'
    secrets:
      SONAR_TOKEN:
        required: false

jobs:
  # â”€â”€ Stage 1: Governance Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-governance:
    name: Web â€” Governance Checks
    uses: ./.github/workflows/governance-check.yml
    with:
      working-directory: '.'   # ðŸ‘ˆ NOW RUNS IN ROOT
      test-command: 'npx vitest run --coverage --reporter=verbose'
      coverage-threshold: ${{ inputs.coverage-threshold }}
      artifact-name: ${{ inputs.system-dir }} # ðŸ‘ˆ PASS NAME EXPLICITLY

  # â”€â”€ Stage 2: SonarCloud Quality Gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-sonarcloud:
    name: Web â€” SonarCloud Analysis
    needs: web-governance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-coverage
          path: coverage

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .   # ðŸ‘ˆ NOW RUNS IN ROOT
          args: >
            -Dsonar.organization=${{ inputs.sonar-organization }}
            -Dsonar.projectKey=${{ inputs.sonar-project-key }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  # â”€â”€ Stage 3: Build Web Application â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-build:
    name: Web â€” Build
    needs: web-sonarcloud
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .   # ðŸ‘ˆ NOW RUNS IN ROOT
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci

      - name: Fix Vite Entry Point
        run: |
            if [ -f "public/index.html" ] && [ ! -f "index.html" ]; then
                mv public/index.html .
            fi

      - name: Build Application
        run: npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-web-build
          path: dist
          retention-days: 14
